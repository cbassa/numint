#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <math.h>
#include "vecmat.h"

#define D2R M_PI/180.0
#define R2D 180.0/M_PI

static const struct {
  int nm1,nm,nf,nd,nn;
  double s,st;
  double c,ct;
} nut[] = {
  {  0,  0,  0,  0,  1, -171996.0, -174.2,  92025.0,    8.9 },
  {  0,  0,  0,  0,  2,    2062.0,    0.2,   -895.0,    0.5 },
  { -2,  0,  2,  0,  1,      46.0,    0.0,    -24.0,    0.0 },
  {  2,  0, -2,  0,  0,      11.0,    0.0,      0.0,    0.0 },
  { -2,  0,  2,  0,  2,      -3.0,    0.0,      1.0,    0.0 },
  {  1, -1,  0, -1,  0,      -3.0,    0.0,      0.0,    0.0 },
  {  0, -2,  2, -2,  1,      -2.0,    0.0,      1.0,    0.0 },
  {  2,  0, -2,  0,  1,       1.0,    0.0,      0.0,    0.0 },
  {  0,  0,  2, -2,  2,  -13187.0,   -1.6,   5736.0,   -3.1 },
  {  0,  1,  0,  0,  0,    1426.0,   -3.4,     54.0,   -0.1 },
  {  0,  1,  2, -2,  2,    -517.0,    1.2,    224.0,   -0.6 },
  {  0, -1,  2, -2,  2,     217.0,   -0.5,    -95.0,    0.3 },
  {  0,  0,  2, -2,  1,     129.0,    0.1,    -70.0,    0.0 },
  {  2,  0,  0, -2,  0,      48.0,    0.0,      1.0,    0.0 },
  {  0,  0,  2, -2,  0,     -22.0,    0.0,      0.0,    0.0 },
  {  0,  2,  0,  0,  0,      17.0,   -0.1,      0.0,    0.0 },
  {  0,  1,  0,  0,  1,     -15.0,    0.0,      9.0,    0.0 },
  {  0,  2,  2, -2,  2,     -16.0,    0.1,      7.0,    0.0 },
  {  0, -1,  0,  0,  1,     -12.0,    0.0,      6.0,    0.0 },
  { -2,  0,  0,  2,  1,      -6.0,    0.0,      3.0,    0.0 },
  {  0, -1,  2, -2,  1,      -5.0,    0.0,      3.0,    0.0 },
  {  2,  0,  0, -2,  1,       4.0,    0.0,     -2.0,    0.0 },
  {  0,  1,  2, -2,  1,       4.0,    0.0,     -2.0,    0.0 },
  {  1,  0,  0, -1,  0,      -4.0,    0.0,      0.0,    0.0 },
  {  2,  1,  0, -2,  0,       1.0,    0.0,      0.0,    0.0 },
  {  0,  0, -2,  2,  1,       1.0,    0.0,      0.0,    0.0 },
  {  0,  1, -2,  2,  0,      -1.0,    0.0,      0.0,    0.0 },
  {  0,  1,  0,  0,  2,       1.0,    0.0,      0.0,    0.0 },
  { -1,  0,  0,  1,  1,       1.0,    0.0,      0.0,    0.0 },
  {  0,  1,  2, -2,  0,      -1.0,    0.0,      0.0,    0.0 },
  {  0,  0,  2,  0,  2,   -2274.0,   -0.2,    977.0,   -0.5 },
  {  1,  0,  0,  0,  0,     712.0,    0.1,     -7.0,    0.0 },
  {  0,  0,  2,  0,  1,    -386.0,   -0.4,    200.0,    0.0 },
  {  1,  0,  2,  0,  2,    -301.0,    0.0,    129.0,   -0.1 },
  {  1,  0,  0, -2,  0,    -158.0,    0.0,     -1.0,    0.0 },
  { -1,  0,  2,  0,  2,     123.0,    0.0,    -53.0,    0.0 },
  {  0,  0,  0,  2,  0,      63.0,    0.0,     -2.0,    0.0 },
  {  1,  0,  0,  0,  1,      63.0,    0.1,    -33.0,    0.0 },
  { -1,  0,  0,  0,  1,     -58.0,   -0.1,     32.0,    0.0 },
  { -1,  0,  2,  2,  2,     -59.0,    0.0,     26.0,    0.0 },
  {  1,  0,  2,  0,  1,     -51.0,    0.0,     27.0,    0.0 },
  {  0,  0,  2,  2,  2,     -38.0,    0.0,     16.0,    0.0 },
  {  2,  0,  0,  0,  0,      29.0,    0.0,     -1.0,    0.0 },
  {  1,  0,  2, -2,  2,      29.0,    0.0,    -12.0,    0.0 },
  {  2,  0,  2,  0,  2,     -31.0,    0.0,     13.0,    0.0 },
  {  0,  0,  2,  0,  0,      26.0,    0.0,     -1.0,    0.0 },
  { -1,  0,  2,  0,  1,      21.0,    0.0,    -10.0,    0.0 },
  { -1,  0,  0,  2,  1,      16.0,    0.0,     -8.0,    0.0 },
  {  1,  0,  0, -2,  1,     -13.0,    0.0,      7.0,    0.0 },
  { -1,  0,  2,  2,  1,     -10.0,    0.0,      5.0,    0.0 },
  {  1,  1,  0, -2,  0,      -7.0,    0.0,      0.0,    0.0 },
  {  0,  1,  2,  0,  2,       7.0,    0.0,     -3.0,    0.0 },
  {  0, -1,  2,  0,  2,      -7.0,    0.0,      3.0,    0.0 },
  {  1,  0,  2,  2,  2,      -8.0,    0.0,      3.0,    0.0 },
  {  1,  0,  0,  2,  0,       6.0,    0.0,      0.0,    0.0 },
  {  2,  0,  2, -2,  2,       6.0,    0.0,     -3.0,    0.0 },
  {  0,  0,  0,  2,  1,      -6.0,    0.0,      3.0,    0.0 },
  {  0,  0,  2,  2,  1,      -7.0,    0.0,      3.0,    0.0 },
  {  1,  0,  2, -2,  1,       6.0,    0.0,     -3.0,    0.0 },
  {  0,  0,  0, -2,  1,      -5.0,    0.0,      3.0,    0.0 },
  {  1, -1,  0,  0,  0,       5.0,    0.0,      0.0,    0.0 },
  {  2,  0,  2,  0,  1,      -5.0,    0.0,      3.0,    0.0 },
  {  0,  1,  0, -2,  0,      -4.0,    0.0,      0.0,    0.0 },
  {  1,  0, -2,  0,  0,       4.0,    0.0,      0.0,    0.0 },
  {  0,  0,  0,  1,  0,      -4.0,    0.0,      0.0,    0.0 },
  {  1,  1,  0,  0,  0,      -3.0,    0.0,      0.0,    0.0 },
  {  1,  0,  2,  0,  0,       3.0,    0.0,      0.0,    0.0 },
  {  1, -1,  2,  0,  2,      -3.0,    0.0,      1.0,    0.0 },
  { -1, -1,  2,  2,  2,      -3.0,    0.0,      1.0,    0.0 },
  { -2,  0,  0,  0,  1,      -2.0,    0.0,      1.0,    0.0 },
  {  3,  0,  2,  0,  2,      -3.0,    0.0,      1.0,    0.0 },
  {  0, -1,  2,  2,  2,      -3.0,    0.0,      1.0,    0.0 },
  {  1,  1,  2,  0,  2,       2.0,    0.0,     -1.0,    0.0 },
  { -1,  0,  2, -2,  1,      -2.0,    0.0,      1.0,    0.0 },
  {  2,  0,  0,  0,  1,       2.0,    0.0,     -1.0,    0.0 },
  {  1,  0,  0,  0,  2,      -2.0,    0.0,      1.0,    0.0 },
  {  3,  0,  0,  0,  0,       2.0,    0.0,      0.0,    0.0 },
  {  0,  0,  2,  1,  2,       2.0,    0.0,     -1.0,    0.0 },
  { -1,  0,  0,  0,  2,       1.0,    0.0,     -1.0,    0.0 },
  {  1,  0,  0, -4,  0,      -1.0,    0.0,      0.0,    0.0 },
  { -2,  0,  2,  2,  2,       1.0,    0.0,     -1.0,    0.0 },
  { -1,  0,  2,  4,  2,      -2.0,    0.0,      1.0,    0.0 },
  {  2,  0,  0, -4,  0,      -1.0,    0.0,      0.0,    0.0 },
  {  1,  1,  2, -2,  2,       1.0,    0.0,     -1.0,    0.0 },
  {  1,  0,  2,  2,  1,      -1.0,    0.0,      1.0,    0.0 },
  { -2,  0,  2,  4,  2,      -1.0,    0.0,      1.0,    0.0 },
  { -1,  0,  4,  0,  2,       1.0,    0.0,      0.0,    0.0 },
  {  1, -1,  0, -2,  0,       1.0,    0.0,      0.0,    0.0 },
  {  2,  0,  2, -2,  1,       1.0,    0.0,     -1.0,    0.0 },
  {  2,  0,  2,  2,  2,      -1.0,    0.0,      0.0,    0.0 },
  {  1,  0,  0,  2,  1,      -1.0,    0.0,      0.0,    0.0 },
  {  0,  0,  4, -2,  2,       1.0,    0.0,      0.0,    0.0 },
  {  3,  0,  2, -2,  2,       1.0,    0.0,      0.0,    0.0 },
  {  1,  0,  2, -2,  0,      -1.0,    0.0,      0.0,    0.0 },
  {  0,  1,  2,  0,  1,       1.0,    0.0,      0.0,    0.0 },
  { -1, -1,  0,  2,  1,       1.0,    0.0,      0.0,    0.0 },
  {  0,  0, -2,  0,  1,      -1.0,    0.0,      0.0,    0.0 },
  {  0,  0,  2, -1,  2,      -1.0,    0.0,      0.0,    0.0 },
  {  0,  1,  0,  2,  0,      -1.0,    0.0,      0.0,    0.0 },
  {  1,  0, -2, -2,  0,      -1.0,    0.0,      0.0,    0.0 },
  {  0, -1,  2,  0,  1,      -1.0,    0.0,      0.0,    0.0 },
  {  1,  1,  0, -2,  1,      -1.0,    0.0,      0.0,    0.0 },
  {  1,  0, -2,  2,  0,      -1.0,    0.0,      0.0,    0.0 },
  {  2,  0,  0,  2,  0,       1.0,    0.0,      0.0,    0.0 },
  {  0,  0,  2,  4,  2,      -1.0,    0.0,      0.0,    0.0 },
  {  0,  1,  0,  1,  0,       1.0,    0.0,      0.0,    0.0 }
};


// Return x modulo y [0,y)
double modulo(double x,double y)
{
  x=fmod(x,y);
  if (x<0.0) x+=y;

  return x;
}

// Greenwich Mean Sidereal Time
double gmst(double mjd)
{
  double t,gmst;

  t=(mjd-51544.5)/36525.0;

  gmst=modulo(280.46061837+360.98564736629*(mjd-51544.5)+t*t*(0.000387933-t/38710000),360.0)*D2R;

  return gmst;
}

// Nutation
void nutation(double mjd,double *dpsi,double *deps,double *eps)
{
  int i;
  double t,t2,t3;
  double d,m,m1,f,n;
  double arg;

  // Julian centuries
  t=(mjd-51544.5)/36525.0;
  t2=t*t;
  t3=t2*t;

  // Angles
  d=modulo(297.85036+445267.111480*t-0.0019142*t2+t3/189474.0,360.0)*D2R;
  m=modulo(357.52772+35999.050340*t-0.0001603*t2-t3/300000.0,360.0)*D2R;
  m1=modulo(134.96298+477198.867398*t+0.0086972*t2+t3/56250.0,360.0)*D2R;
  f=modulo(93.27191+483202.017538*t-0.0036825*t2+t3/327270.0,360.0)*D2R;
  n=modulo(125.04452-1934.136261*t+0.0020708*t2+t3/450000.0,360.0)*D2R;
  
  // Compute sums
  *dpsi=0.0;
  *deps=0.0;
  for (i=0;i<106;i++) {
    arg=nut[i].nd*d+nut[i].nm*m+nut[i].nm1*m1+nut[i].nf*f+nut[i].nn*n;
    *dpsi+=(nut[i].s+nut[i].st*t)*sin(arg);
    *deps+=(nut[i].c+nut[i].ct*t)*cos(arg);
  }
  *dpsi*=0.0001/3600*D2R;
  *deps*=0.0001/3600*D2R;
  *eps=-46.8150*t-0.00059*t2+0.001813*t3;
  *eps=(23.4392911+ *eps/3600.0)*D2R;

  return;
}

// Precession
void precess(double mjd0,double mjd,double *zeta,double *z,double *theta)
{
  double t0,t;

  // Time in centuries
  t0=(mjd0-51544.5)/36525.0;
  t=(mjd-mjd0)/36525.0;

  // Precession angles
  *zeta=(2306.2181+1.39656*t0-0.000139*t0*t0)*t;
  *zeta+=(0.30188-0.000344*t0)*t*t+0.017998*t*t*t;
  *zeta*=D2R/3600.0;
  *z=(2306.2181+1.39656*t0-0.000139*t0*t0)*t;
  *z+=(1.09468+0.000066*t0)*t*t+0.018203*t*t*t;
  *z*=D2R/3600.0;
  *theta=(2004.3109-0.85330*t0-0.000217*t0*t0)*t;
  *theta+=-(0.42665+0.000217*t0)*t*t-0.041833*t*t*t;
  *theta*=D2R/3600.0;
  
  return;
}

// ICRS to ITRS conversion
void icrs_to_itrs(double mjd,double a[3][3])
{
  int i,j;
  double dpsi,deps,eps,z,theta,zeta,h;
  double p[3][3],n[3][3],g[3][3],c[3][3],b[3][3];

  // Precession
  precess(51544.5,mjd,&zeta,&z,&theta);
  identity_matrix(p);
  rotate_z(-zeta,p);
  rotate_y(theta,p);
  rotate_z(-z,p);

  // Nutation
  nutation(mjd,&dpsi,&deps,&eps);
  identity_matrix(n);
  rotate_x(eps,n);
  rotate_z(-dpsi,n);
  rotate_x(-eps-deps,n);

  // Earth orientation
  h=gmst(mjd);
  identity_matrix(g);
  rotate_z(h+dpsi*cos(eps+deps),g);

  // Polar motion
  identity_matrix(c);

  // Multiply matrices (left to right)
  matrix_multiply(c,g,a);
  matrix_multiply(a,n,b);
  matrix_multiply(b,p,a);

  // Hardcode to earth orientation only
  rotate_z(h+dpsi*cos(eps+deps),a);

  return;
}

